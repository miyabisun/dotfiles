#!/bin/bash
set -e

if ! command -v bw &> /dev/null; then
    echo "Error: 'bw' command not found."
    echo "Please install Bitwarden CLI: https://bitwarden.com/help/cli/"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: 'jq' command not found."
    echo "Please install jq."
    exit 1
fi

# Check if vault is unlocked
STATUS=$(bw status | jq -r .status)
if [ "$STATUS" != "unlocked" ]; then
    echo "Error: Bitwarden vault is locked. Run 'bw login' or 'bw unlock'."
    exit 1
fi

# Find folder ID for "SSH Config"
FOLDER_ID=$(bw list folders --search "SSH Config" | jq -r '.[] | select(.name == "SSH Config") | .id' | head -n 1)

if [ -z "$FOLDER_ID" ] || [ "$FOLDER_ID" == "null" ]; then
    echo "Error: Folder 'SSH Config' not found in Bitwarden."
    exit 1
fi

# Ensure directories exist
mkdir -p "$HOME/.ssh/conf.d"

echo "Fetching items from 'SSH Config' folder..."
ITEMS=$(bw list items --folderid "$FOLDER_ID")

# Process each item
echo "$ITEMS" | jq -c '.[]' | while read -r item; do
    NAME=$(echo "$item" | jq -r '.name')
    URI=$(echo "$item" | jq -r '.login.uris[0].uri // empty')
    USER=$(echo "$item" | jq -r '.login.username // empty')
    
    echo "Restoring config for '$NAME'..."
    
    CONFIG_FILE="$HOME/.ssh/conf.d/${NAME}.conf"
    
    # Start config content
    echo "# Generated by bin/load-ssh-configs on $(date)" > "$CONFIG_FILE"
    echo "Host $NAME" >> "$CONFIG_FILE"
    
    if [ -n "$URI" ]; then
        echo "  HostName $URI" >> "$CONFIG_FILE"
    fi
    
    if [ -n "$USER" ]; then
        echo "  User $USER" >> "$CONFIG_FILE"
    fi
    
    # Process fields
    echo "$item" | jq -c '.fields[]?' | while read -r field; do
        FIELD_NAME=$(echo "$field" | jq -r '.name')
        FIELD_VALUE=$(echo "$field" | jq -r '.value')
        
        if [ "$FIELD_NAME" == "IdentityFile" ]; then
            # Special handling for IdentityFile: prepend ~/.ssh/
            echo "  $FIELD_NAME ~/.ssh/$FIELD_VALUE" >> "$CONFIG_FILE"
        else
            echo "  $FIELD_NAME $FIELD_VALUE" >> "$CONFIG_FILE"
        fi
    done
    
    echo "  Saved to $CONFIG_FILE"
done

echo "Done."
