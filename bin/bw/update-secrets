#!/bin/bash
set -e

OUTPUT_FILE="$HOME/.config/.secrets"

if ! command -v bw &> /dev/null; then
    echo "Error: 'bw' command not found."
    echo "Please install Bitwarden CLI: https://bitwarden.com/help/cli/"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: 'jq' command not found."
    echo "Please install jq."
    exit 1
fi

# Check if vault is unlocked (simplistic check, ignoring issues if jq fails significantly)
STATUS=$(bw status | jq -r .status)
if [ "$STATUS" != "unlocked" ]; then
    echo "Error: Bitwarden vault is locked. Run 'bw login' or 'bw unlock'."
    exit 1
fi

# Find folder ID for "CLI"
FOLDER_ID=$(bw list folders --search "CLI" | jq -r '.[] | select(.name == "CLI") | .id' | head -n 1)

if [ -z "$FOLDER_ID" ] || [ "$FOLDER_ID" == "null" ]; then
    echo "Error: Folder 'CLI' not found in Bitwarden."
    exit 1
fi

echo "Fetching secrets from 'CLI' folder..."

# Initialize file
echo "# Generated by bin/update-secret on $(date)" > "$OUTPUT_FILE"
chmod 600 "$OUTPUT_FILE"

# Fetch items and format as export KEY="VALUE"
# Note: This assumes item names are valid environment variable keys. 
# We replace spaces with underscores just in case.
bw list items --folderid "$FOLDER_ID" | jq -r '.[] | "export \(.name | gsub(" "; "_"))=\"\(.login.password)\""' >> "$OUTPUT_FILE"

echo "Secrets updated in $OUTPUT_FILE"
