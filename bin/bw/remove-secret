#!/bin/bash
set -e

NAME="$1"

if [ -z "$NAME" ]; then
    echo "Usage: $0 <name>"
    exit 1
fi

if ! command -v bw &> /dev/null; then
    echo "Error: 'bw' command not found."
    echo "Please install Bitwarden CLI: https://bitwarden.com/help/cli/"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: 'jq' command not found."
    echo "Please install jq."
    exit 1
fi

# Check if vault is unlocked
STATUS=$(bw status | jq -r .status)
if [ "$STATUS" != "unlocked" ]; then
    echo "Error: Bitwarden vault is locked. Run 'bw login' or 'bw unlock'."
    exit 1
fi

# Find folder ID for "CLI"
FOLDER_ID=$(bw list folders --search "CLI" | jq -r '.[] | select(.name == "CLI") | .id' | head -n 1)

if [ -z "$FOLDER_ID" ] || [ "$FOLDER_ID" == "null" ]; then
    echo "Error: Folder 'CLI' not found in Bitwarden."
    exit 1
fi

# Get IDs for the selected name
ITEM_IDS=$(bw list items --search "$NAME" | jq -r --arg folderId "$FOLDER_ID" --arg name "$NAME" '.[] | select(.folderId == $folderId and .name == $name) | .id')

if [ -z "$ITEM_IDS" ]; then
    echo "not found secret: $NAME"
    exit 1
fi

echo "Deleting secret '$NAME'..."
echo "$ITEM_IDS" | while read -r id; do
    if [ -n "$id" ]; then
        bw delete item "$id" > /dev/null
        echo "Deleted item ID: $id"
    fi
done

echo "Syncing Bitwarden..."
bw sync

echo "Updating local secrets..."
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/update-secrets" ]; then
    "$SCRIPT_DIR/update-secrets"
else
    echo "Warning: update-secrets script not found at $SCRIPT_DIR/update-secrets"
fi

echo "Done."
