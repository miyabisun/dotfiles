#!/bin/bash
script_dir="$(cd "$(dirname "${BASH_SOURCE:-${(%):-%N}}")"; pwd)"
cd "$script_dir/../"

function link () {
  from="$(pwd)/$1"
  to="${2:-$HOME}"
  ln -sfv "$from" "$to"
}

link ".editorconfig"


mkdir -p "$HOME/.ssh/conf.d"
link "ssh/config" "$HOME/.ssh"

mkdir -p "$HOME/.config"
link "config/git" "$HOME/.config"
link "config/nvim" "$HOME/.config"
link "config/tmux" "$HOME/.config"
link "config/.deepl.json" "$HOME/.config"

mkdir -p "$HOME/.claude"
link "agents/skills" "$HOME/.claude"
link "agents/CLAUDE.md" "$HOME/.claude"

mkdir -p "$HOME/.agents"
link "agents/skills" "$HOME/.agents"


START_MARK="# DOTFILES_START"
END_MARK="# DOTFILES_END"

for rcfile in "$HOME/.bashrc" "$HOME/.zshrc"; do
  if [ -f "$rcfile" ]; then
    if ! grep -q "$START_MARK" "$rcfile"; then
      echo "Adding dotfiles config to $rcfile..."
      cat <<EOT >> "$rcfile"

$START_MARK
if [ -f ~/.config/.secrets ]; then
  source ~/.config/.secrets
fi
export PATH="\$HOME/.dotfiles/bin/bw:\$PATH"
$END_MARK
EOT
    else
      echo "Dotfiles config already present in $rcfile."
    fi
  fi
done

