#!/bin/bash
set -e

KEY_NAME="$1"
PASSWORD="$2"

if [ -z "$KEY_NAME" ] || [ -z "$PASSWORD" ]; then
    echo "Usage: $0 <key_name> <password>"
    exit 1
fi

if ! command -v bw &> /dev/null; then
    echo "Error: 'bw' command not found."
    echo "Please install Bitwarden CLI: https://bitwarden.com/help/cli/"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: 'jq' command not found."
    echo "Please install jq."
    exit 1
fi

# Check if vault is unlocked
STATUS=$(bw status | jq -r .status)
if [ "$STATUS" != "unlocked" ]; then
    echo "Error: Bitwarden vault is locked. Run 'bw login' or 'bw unlock'."
    exit 1
fi

# Find folder ID for "CLI"
FOLDER_ID=$(bw list folders --search "CLI" | jq -r '.[] | select(.name == "CLI") | .id' | head -n 1)

if [ -z "$FOLDER_ID" ] || [ "$FOLDER_ID" == "null" ]; then
    echo "Error: Folder 'CLI' not found in Bitwarden."
    exit 1
fi


# Check for existing items with the same name in the folder and delete them
EXISTING_IDS=$(bw list items --folderid "$FOLDER_ID" | jq -r --arg name "$KEY_NAME" '.[] | select(.name == $name) | .id')

if [ -n "$EXISTING_IDS" ]; then
    echo "Found existing item(s) with name '$KEY_NAME'. Deleting..."
    echo "$EXISTING_IDS" | while read -r id; do
        if [ -n "$id" ]; then
            bw delete item "$id" > /dev/null
            echo "Deleted item ID: $id"
        fi
    done
fi

echo "Creating item '$KEY_NAME' in 'CLI' folder..."

# Create JSON payload
ITEM=$(jq -n \
  --arg name "$KEY_NAME" \
  --arg password "$PASSWORD" \
  --arg folderId "$FOLDER_ID" \
  '{
    type: 1,
    name: $name,
    login: {
      username: $name,
      password: $password
    },
    folderId: $folderId
  }')

# Create item in Bitwarden using encode to handle special characters properly if needed, but here simple passing is fine
echo "$ITEM" | bw encode | bw create item > /dev/null

echo "Item created."
echo "Syncing Bitwarden..."
bw sync

echo "Updating local secrets..."
# Get the directory of this script to run update-secrets properly
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
"$SCRIPT_DIR/update-secrets"

echo "Done."
