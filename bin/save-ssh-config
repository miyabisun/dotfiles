#!/bin/bash
set -e

if ! command -v fzf &> /dev/null; then
    echo "Error: 'fzf' command not found."
    echo "Please install fzf."
    exit 1
fi

NAME=$(find "$HOME/.ssh/conf.d" -maxdepth 1 -name "*.conf" -printf "%f\n" | sed 's/\.conf$//' | fzf)

if [ -z "$NAME" ]; then
    echo "No file selected. Exiting."
    exit 0
fi

echo "Select config file to save: $NAME"

CONFIG_FILE="$HOME/.ssh/conf.d/${NAME}.conf"

if [ ! -f "$CONFIG_FILE" ]; then
    # Should not happen with fzf selection from find, but good safety
    echo "Error: Config file not found at $CONFIG_FILE"
    exit 1
fi

if ! command -v bw &> /dev/null; then
    echo "Error: 'bw' command not found."
    echo "Please install Bitwarden CLI: https://bitwarden.com/help/cli/"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "Error: 'jq' command not found."
    echo "Please install jq."
    exit 1
fi

# Check if vault is unlocked
STATUS=$(bw status | jq -r .status)
if [ "$STATUS" != "unlocked" ]; then
    echo "Error: Bitwarden vault is locked. Run 'bw login' or 'bw unlock'."
    exit 1
fi

# Find folder ID for "SSH Config"
FOLDER_ID=$(bw list folders --search "SSH Config" | jq -r '.[] | select(.name == "SSH Config") | .id' | head -n 1)

if [ -z "$FOLDER_ID" ] || [ "$FOLDER_ID" == "null" ]; then
    echo "Error: Folder 'SSH Config' not found in Bitwarden. Please create it first."
    exit 1
fi

# Check for existing items with the same name in the folder and delete them
EXISTING_IDS=$(bw list items --folderid "$FOLDER_ID" | jq -r --arg name "$NAME" '.[] | select(.name == $name) | .id')

if [ -n "$EXISTING_IDS" ]; then
    echo "Found existing item(s) with name '$NAME' in 'SSH Config'. Deleting..."
    echo "$EXISTING_IDS" | while read -r id; do
        if [ -n "$id" ]; then
            bw delete item "$id" > /dev/null
            echo "Deleted item ID: $id"
        fi
    done
fi

echo "Parsing config file..."

BW_URI=""
BW_USER=""
FIELDS="[]"

while read -r line; do
    # Trim whitespace
    line=$(echo "$line" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
    
    # Skip empty lines and comments
    if [ -z "$line" ] || [[ "$line" == \#* ]]; then
        continue
    fi
    
    # Split key and value (space separated)
    key=$(echo "$line" | awk '{print $1}')
    value=$(echo "$line" | awk '{$1=""; print $0}' | sed -e 's/^[[:space:]]*//')
    
    case "$key" in
        Host)
            # Ignore Host line as requested
            ;;
        HostName)
            BW_URI="$value"
            ;;
        User)
            BW_USER="$value"
            ;;
        IdentityFile)
            # Extract filename using basename
            filename=$(basename "$value")
            # Add to fields
            FIELDS=$(echo "$FIELDS" | jq --arg name "$key" --arg value "$filename" '. + [{name: $name, value: $value, type: 0}]')
            ;;
        *)
            # Add other keys to fields
            FIELDS=$(echo "$FIELDS" | jq --arg name "$key" --arg value "$value" '. + [{name: $name, value: $value, type: 0}]')
            ;;
    esac
done < "$CONFIG_FILE"

echo "Saving config to Bitwarden item '$NAME'..."

# Create JSON payload
# Type 1 is Login
ITEM=$(jq -n \
  --arg name "$NAME" \
  --arg folderId "$FOLDER_ID" \
  --arg username "$BW_USER" \
  --arg uri "$BW_URI" \
  --argjson fields "$FIELDS" \
  '{
    type: 1,
    name: $name,
    folderId: $folderId,
    login: {
      username: $username,
      uris: (if $uri != "" then [{match: null, uri: $uri}] else [] end)
    },
    fields: $fields
  }')

echo "$ITEM" | bw encode | bw create item > /dev/null

echo "Done. Saved '$NAME' to 'SSH Config' folder."
